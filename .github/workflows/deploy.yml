name: Deploy and Fix

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # 1. Try to Open Firewall (This is likely the issue)
          sudo ufw allow 80
          sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT

          # 2. Go to app folder
          cd app
          
          # 3. Force install dependencies to be safe
          sudo pip3 install fastapi uvicorn --break-system-packages

          # 4. Kill any existing process
          sudo fuser -k 80/tcp || true

          # 5. Start App and save logs
          nohup sudo python3 main.py > output.log 2>&1 &
          
          # 6. Wait 5 seconds to ensure it starts
          sleep 5
          
          # 7. Check if it is actually running
          if ! pgrep -f "python3 main.py" > /dev/null; then
            echo "CRASH DETECTED! Here are the error logs:"
            cat output.log
            exit 1
          else
            echo "SUCCESS: App is running. Recent logs:"
            cat output.log
          fi
