name: Force Repair and Deploy

on:
  push:
    branches:
      - main

jobs:
  repair_and_deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy using SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # 1. Stop everything
          sudo fuser -k 80/tcp || true
          
          # 2. Setup folder and permissions
          mkdir -p app
          cd app
          
          # 3. FORCE CREATE main.py (Bypassing Windows encoding issues)
          echo 'from fastapi import FastAPI' > main.py
          echo 'import uvicorn' >> main.py
          echo 'app = FastAPI()' >> main.py
          echo '@app.get("/sayHello")' >> main.py
          echo 'def say_hello():' >> main.py
          echo '    return {"message": "Hello User"}' >> main.py
          echo 'if __name__ == "__main__":' >> main.py
          echo '    uvicorn.run(app, host="0.0.0.0", port=80)' >> main.py
          
          # 4. Install Dependencies
          sudo apt-get update
          sudo apt-get install -y python3-pip
          sudo pip3 install fastapi uvicorn --break-system-packages
          
          # 5. Start Server
          nohup sudo python3 main.py > output.log 2>&1 &
          
          # 6. Wait and Verify
          echo "Waiting for server to start..."
          sleep 5
          
          # 7. Test Locally (The crucial check)
          if curl -v http://127.0.0.1/sayHello; then
             echo "SUCCESS: Server is responding!"
          else
             echo "FAILURE: Server crashed. Logs:"
             cat output.log
             exit 1
          fi
