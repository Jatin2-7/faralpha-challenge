name: Final Venv Fix Port 80

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy using SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # 1. KILL OLD PROCESSES
          sudo fuser -k 80/tcp || true
          rm -rf app
          mkdir app
          cd app

          # 2. WRITE MAIN.PY (STRICTLY PORT 80)
          echo 'from fastapi import FastAPI' > main.py
          echo 'import uvicorn' >> main.py
          echo 'app = FastAPI()' >> main.py
          echo '@app.get("/sayHello")' >> main.py
          echo 'def say_hello():' >> main.py
          echo '    return {"message": "Hello User"}' >> main.py
          echo 'if __name__ == "__main__":' >> main.py
          echo '    uvicorn.run(app, host="0.0.0.0", port=80)' >> main.py

          # 3. SETUP VIRTUAL ENV (This fixes the ModuleNotFoundError)
          sudo apt-get update
          sudo apt-get install -y python3-venv python3-pip
          # Create the virtual environment
          python3 -m venv venv
          
          # 4. INSTALL PACKAGES INTO VENV
          # We use the venv's pip directly
          ./venv/bin/pip install fastapi uvicorn

          # 5. START SERVER (sudo is required for Port 80)
          # We use the venv's python directly with sudo
          nohup sudo ./venv/bin/python3 main.py > output.log 2>&1 &

          # 6. VERIFY
          echo "Waiting 10 seconds for startup..."
          sleep 10
          
          if curl -v http://127.0.0.1/sayHello; then
             echo "SUCCESS: Server is running on Port 80!"
             exit 0
          else
             echo "FAILURE: Server crashed. Logs:"
             cat output.log
             exit 1
          fi
