name: Final Fix with Dos2Unix

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Copy Files
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "main.py,requirements.txt"
        target: "app"

    - name: Fix Formatting and Run
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # 1. Stop old process
          sudo fuser -k 80/tcp || true
          cd app
          
          # 2. Install tool to fix Windows file endings
          sudo apt-get update
          sudo apt-get install -y dos2unix python3-pip
          
          # 3. Fix the files (This solves the crash!)
          dos2unix main.py requirements.txt
          
          # 4. Install python libraries
          sudo pip3 install -r requirements.txt --break-system-packages
          
          # 5. Start the app
          nohup sudo python3 main.py > output.log 2>&1 &
          
          # 6. Verify
          echo "Waiting for start..."
          sleep 5
          if curl -v http://127.0.0.1/sayHello; then
             echo "SUCCESS: App is running!"
          else
             echo "FAIL: App crashed. Logs:"
             cat output.log
             exit 1
          fi
