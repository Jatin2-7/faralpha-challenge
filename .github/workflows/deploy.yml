name: Zero Downtime Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy using SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # 1. Prepare Folder
          mkdir -p app
          cd app

          # 2. Update Code Atomically
          echo 'from fastapi import FastAPI' > main.py.tmp
          echo 'import uvicorn' >> main.py.tmp
          echo 'app = FastAPI()' >> main.py.tmp
          echo '@app.get("/sayHello")' >> main.py.tmp
          echo 'def say_hello():' >> main.py.tmp
          echo '    return {"message": "Hello User"}' >> main.py.tmp
          mv main.py.tmp main.py

          # 3. Setup Environment
          sudo apt-get update
          # Install lsof to safely find the process on Port 80
          sudo apt-get install -y python3-venv python3-pip lsof
          if [ ! -d "venv" ]; then
              python3 -m venv venv
          fi
          
          # Install Gunicorn
          sudo ./venv/bin/pip install fastapi uvicorn gunicorn

          # 4. Zero Downtime Logic (The Robust Fix)
          # "lsof" finds the exact PID listening on Port 80. 
          # It ignores the script, workers, and everything else.
          PID=$(sudo lsof -t -i:80 -sTCP:LISTEN)

          if [ -n "$PID" ]; then
              echo "Gunicorn Master found listening on Port 80 (PID: $PID). Sending Reload Signal..."
              # SIGHUP tells the master to reload the code with zero downtime
              sudo kill -HUP $PID
          else
              echo "No process found on Port 80. Starting fresh..."
              # Cleanup just in case
              sudo fuser -k 80/tcp || true
              
              # Start Gunicorn in Daemon mode
              sudo ./venv/bin/gunicorn -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:80 -D
          fi

          # 5. Verification
          echo "Waiting for reload..."
          sleep 5
          if curl -v http://127.0.0.1/sayHello; then
             echo "SUCCESS: App is running!"
             exit 0
          else
             echo "FAILURE: App crashed."
             exit 1
          fi
